{% extends "base.html" %}
{% block content %}
    <h1>Welcome to MemoSquare</h1>
    <img src="/static/memosquare/img/logo_main.gif"/>
    <table id="idtable">
        <thead>
        <tr>
            <th>location</th>
            <th>email</th>
            <th>username</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td>client-side</td>
            <td id="user-email">no data</td>
            <td id="user-name">no auth</td>
        </tr>
        <tr>
            <td>server-side</td>
            <td>{{ user.username }}</td>
            <td>{{ user.email }}</td>
        </tr>
        </tbody>
    </table>

    <fb:login-button autologoutlink="true" scope="public_profile,email" onlogin="checkLoginState();">
    </fb:login-button>
    <a href="/sign_out" onclick="signOut();" class="waves-effect waves-light btn">sign out</a>
{% endblock %}


{% block javascript %}
<script>
    function statusChangeCallback(response) {
        if (response.status === 'connected') {
            // Logged into your app and Facebook.
            testAPI(response);
        } else if (response.status === 'not_authorized') {
            $('#status').text('Please log into this app.');
        } else {
            $('#status').text('Please log into Facebook.');
        }
    }

    function checkLoginState() {
        FB.getLoginStatus(function (response) {
            statusChangeCallback(response);
        });
    }

    $(document).ready(function () {
        $.ajaxSetup({cache: true});
        $.getScript('//connect.facebook.net/en_US/sdk.js', function () {
            FB.init({
                appId: '1052596834838366',
                cookie: true,
                xfbml: true,
                version: 'v2.5'
            });
            $('#loginbutton,#feedbutton').removeAttr('disabled');
            FB.getLoginStatus(function (response) {
                statusChangeCallback(response);
            });
        });
    });

    function testAPI(response) {
        var token = response.authResponse.accessToken;
        FB.api('/me', {locale: 'en_US', fields: 'name, email'}, function (response) {
            $('#user-email').text(response.email);
            $('#user-name').text(response.name);
            sendToken(token);
        });
    }

    // Send FB token to our server, server make a session
    function sendToken(token) {
        var url = 'http://memosquare.com/sign_in/';
        var settings = {
            method: 'POST',
            data: {'token': token},
            success: function success(result, status, xhr) {
                console.log(result);
            },
            error: function (xhr, status, error) {
                console.log(error);
            }
        };
        $.ajax(url, settings);
    }
</script>
{% endblock %}